<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Vista Form extendida de res.partner para Usuarios App -->
    <record id="view_partner_form_renaix" model="ir.ui.view">
        <field name="name">res.partner.form.renaix</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            
            <!-- Añadir botones estadísticos -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_productos" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-shopping-cart"
                        invisible="not es_usuario_app">
                    <field name="productos_en_venta" widget="statinfo" string="En Venta"/>
                </button>
                <button name="action_view_compras" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-shopping-bag"
                        invisible="not es_usuario_app">
                    <field name="productos_comprados" widget="statinfo" string="Comprados"/>
                </button>
                <button name="action_view_ventas" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-money"
                        invisible="not es_usuario_app">
                    <field name="productos_vendidos" widget="statinfo" string="Vendidos"/>
                </button>
            </xpath>
            
            <!-- Añadir página de Renaix -->
            <xpath expr="//notebook" position="inside">
                <page string="Renaix App" invisible="not es_usuario_app">
                    <group>
                        <group string="Información de Usuario">
                            <field name="es_usuario_app"/>
                            <field name="partner_gid" readonly="1" widget="CopyClipboardChar"/>
                            <field name="fecha_registro_app"/>
                            <field name="cuenta_activa" widget="boolean_toggle"/>
                            <field name="fecha_ultima_actividad"/>
                        </group>
                        <group string="Estadísticas">
                            <field name="valoracion_promedio" widget="progressbar"/>
                            <field name="total_comentarios"/>
                            <field name="total_denuncias_realizadas"/>
                        </group>
                    </group>
                    
                    <group>
                        <group string="Acciones">
                            <button name="action_desactivar_cuenta" 
                                    type="object" 
                                    string="Desactivar Cuenta" 
                                    class="btn-warning"
                                    confirm="¿Está seguro de desactivar esta cuenta?"
                                    invisible="not cuenta_activa"/>
                            <button name="action_activar_cuenta" 
                                    type="object" 
                                    string="Activar Cuenta" 
                                    class="btn-success"
                                    invisible="cuenta_activa"/>
                            <button name="action_regenerar_gid"
                                    type="object"
                                    string="Regenerar GID"
                                    class="btn-secondary"
                                    confirm="⚠️ ADVERTENCIA: Esto generará un nuevo UUID. Los dispositivos con el GID antiguo perderán acceso. ¿Continuar?"
                                    groups="base.group_system"
                                    invisible="not partner_gid"/>
                        </group>
                        <group string="API">
                            <field name="api_token" password="True" groups="base.group_system"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Productos" invisible="not producto_ids">
                            <field name="producto_ids" readonly="1">
                                <list>
                                    <field name="name"/>
                                    <field name="categoria_id"/>
                                    <field name="precio" widget="monetary"/>
                                    <field name="estado_venta"/>
                                    <field name="fecha_publicacion"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Compras" invisible="not compra_comprador_ids">
                            <field name="compra_comprador_ids" readonly="1">
                                <list>
                                    <field name="producto_id"/>
                                    <field name="vendedor_id"/>
                                    <field name="precio_final" widget="monetary"/>
                                    <field name="estado"/>
                                    <field name="fecha_compra"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Ventas" invisible="not compra_vendedor_ids">
                            <field name="compra_vendedor_ids" readonly="1">
                                <list>
                                    <field name="producto_id"/>
                                    <field name="comprador_id"/>
                                    <field name="precio_final" widget="monetary"/>
                                    <field name="estado"/>
                                    <field name="fecha_compra"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Valoraciones" invisible="not valoracion_ids">
                            <field name="valoracion_ids" readonly="1">
                                <list>
                                    <field name="usuario_valorador_id"/>
                                    <field name="puntuacion" widget="priority"/>
                                    <field name="comentario"/>
                                    <field name="fecha"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </page>
            </xpath>
            
        </field>
    </record>
    
    <!-- Vista list extendida -->
    <record id="view_partner list_renaix" model="ir.ui.view">
        <field name="name">res.partner list.renaix</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner list"/>
        <field name="arch" type="xml">
            <list position="inside">
                <field name="es_usuario_app" optional="hide"/>
                <field name="partner_gid" optional="hide"/>
                <field name="valoracion_promedio" optional="show" invisible="not es_usuario_app"/>
                <field name="productos_en_venta" optional="show" invisible="not es_usuario_app"/>
                <field name="cuenta_activa" optional="show" invisible="not es_usuario_app"/>
            </list>
        </field>
    </record>
    
    <!-- Filtros de búsqueda -->
    <record id="view_partner_search_renaix" model="ir.ui.view">
        <field name="name">res.partner.search.renaix</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                
                <!-- Filtros -->
                <filter string="Usuarios App" 
                        name="usuarios_app" 
                        domain="[('es_usuario_app', '=', True)]"/>
                <filter string="Cuenta Activa" 
                        name="cuenta_activa" 
                        domain="[('cuenta_activa', '=', True)]"/>
                <filter string="Cuenta Inactiva" 
                        name="cuenta_inactiva" 
                        domain="[('cuenta_activa', '=', False)]"/>
                
                <separator/>
                
                <filter string="Con Productos" 
                        name="con_productos" 
                        domain="[('productos_en_venta', '>', 0)]"/>
                <filter string="Con Valoraciones" 
                        name="con_valoraciones" 
                        domain="[('valoracion_promedio', '>', 0)]"/>
                
                <separator/>
                
                <!-- Búsqueda por GID -->
                <field name="partner_gid" string="GID"/>
                
                <!-- Agrupar por -->
                <group expand="0" string="Agrupar Por">
                    <filter string="Cuenta Activa" 
                            name="group_cuenta_activa" 
                            context="{'group_by': 'cuenta_activa'}"/>
                    <filter string="Fecha Registro" 
                            name="group_fecha_registro" 
                            context="{'group_by': 'fecha_registro_app'}"/>
                </group>
                
            </xpath>
        </field>
    </record>
    
    <!-- Acción para Usuarios App -->
    <record id="action_partner_renaix" model="ir.actions.act_window">
        <field name="name">Usuarios App</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">kanban list,form</field>
        <field name="context">{
            'search_default_usuarios_app': 1,
            'default_es_usuario_app': True,
            'default_cuenta_activa': True
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crear nuevo usuario de la app móvil
            </p>
            <p>
                Los usuarios de la app pueden publicar productos, realizar compras y valorar vendedores.
            </p>
        </field>
    </record>
    
</odoo>
